<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manager's Dashboard</title>
  <style>
    /* Global styles */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    /* Container styles */
    .container {
      display: flex;
      height: 100vh;
    }

    /* Navbar styles */
    .navbar {
      width: 20%;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      display: flex;
      flex-direction: column;
    }

    .navbar .logo {
      font-weight: bold;
      font-size: 1.5rem;
      margin-bottom: 30px;
    }

    .navbar .logo span {
      color: #90caf9;
    }

    .navbar .user-info {
      background: rgba(255, 255, 255, 0.1);
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
      font-size: 0.9rem;
    }

    .navbar .nav-links {
      display: flex;
      flex-direction: column;
      gap: 15px;
      flex-grow: 1;
    }

    .navbar .nav-links a {
      text-decoration: none;
      color: white;
      font-size: 1rem;
      cursor: pointer;
      padding: 10px;
      border-radius: 5px;
      transition: background 0.3s;
    }

    .navbar .nav-links a:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .navbar .nav-links a.active {
      background: rgba(255, 255, 255, 0.3);
      font-weight: bold;
    }

    .logout-btn {
      background: #d32f2f;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      margin-top: auto;
      transition: background 0.3s;
    }

    .logout-btn:hover {
      background: #b71c1c;
    }

    /* Dashboard container styles */
    .dashboard-container {
      width: 80%;
      padding: 30px;
      overflow-y: auto;
    }

    .dashboard-container h1 {
      color: #333;
      margin-bottom: 20px;
    }

    /* Stats grid styles */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
      margin-bottom: 40px;
    }

    .stat-card {
      border: 1px solid #ddd;
      padding: 20px;
      border-radius: 8px;
      background: #f5f5f5;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .stat-card h2 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      color: #667eea;
    }

    .stat-card p {
      color: #666;
      margin-bottom: 15px;
    }

    .stat-card button {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 10px;
      width: 100%;
      cursor: pointer;
      border-radius: 5px;
      transition: transform 0.2s;
    }

    .stat-card button:hover {
      transform: translateY(-2px);
    }

    /* Section styles */
    .section {
      display: none;
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .section.active {
      display: block;
    }

    .section h2 {
      color: #333;
      margin-bottom: 20px;
      border-bottom: 2px solid #667eea;
      padding-bottom: 10px;
    }

    /* Form styles */
    form {
      display: grid;
      gap: 15px;
    }

    label {
      font-weight: bold;
      color: #333;
    }

    input, select {
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 1rem;
    }

    input:focus, select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 5px rgba(102, 126, 234, 0.2);
    }

    button[type="submit"] {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: bold;
      transition: transform 0.2s;
    }

    button[type="submit"]:hover {
      transform: translateY(-2px);
    }

    /* Table styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
    }

    table thead {
      background: #667eea;
      color: white;
    }

    table th, table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }

    table tbody tr:hover {
      background: #f5f5f5;
    }

    /* Responsive design */
    @media (max-width: 768px) {
      .container {
        flex-direction: column;
      }

      .navbar {
        width: 100%;
        flex-direction: row;
      }

      .dashboard-container {
        width: 100%;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .navbar .nav-links {
        flex-direction: row;
        gap: 10px;
        flex-grow: 0;
      }
    }

    .message {
      padding: 15px;
      border-radius: 5px;
      margin-bottom: 20px;
    }

    .success {
      background: #c8e6c9;
      color: #2e7d32;
      border: 1px solid #2e7d32;
    }

    .error {
      background: #ffcdd2;
      color: #d32f2f;
      border: 1px solid #d32f2f;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Navbar -->
    <div class="navbar">
      <div class="logo">Manager<span>Dashboard</span></div>
      <div class="user-info" id="userInfo">
        <div id="userPhoto" style="margin-bottom: 10px;">
          <img id="profileImg" src="" alt="Profile" style="width: 60px; height: 60px; border-radius: 50%; object-fit: cover; display: none;">
        </div>
        <div>ðŸ‘¤ <span id="userName">Loading...</span></div>
        <div style="font-size: 0.8rem; margin-top: 5px;" id="userRole">Role: Manager</div>
      </div>
      <div class="nav-links">
        <a onclick="showSection('dashboard')">ðŸ“Š Dashboard</a>
        <a onclick="showSection('procurement')">ðŸ“¦ Procurement</a>
        <a onclick="showSection('stock')">ðŸ“‚ Stock</a>
        <a onclick="showSection('sales')">ðŸ’° Sales</a>
        <a onclick="showSection('reports')">ðŸ“‹ Reports</a>
      </div>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>

    <!-- Dashboard container -->
    <div class="dashboard-container">
      <!-- Dashboard Section -->
      <section id="dashboard" class="section active">
        <h1>DASHBOARD</h1>
        <div class="stats-grid">
          <div class="stat-card">
            <h2 id="totalStock">0</h2>
            <p>Total Stock</p>
            <button onclick="showSection('stock')">View Stock</button>
          </div>
          <div class="stat-card">
            <h2 id="salesToday">0</h2>
            <p>Sales Today</p>
            <button onclick="showSection('sales')">View Sales</button>
          </div>
          <div class="stat-card">
            <h2 id="procurementPending">0</h2>
            <p>Procurement Pending</p>
            <button onclick="showSection('procurement')">View Procurement</button>
          </div>
          <div class="stat-card">
            <h2 id="reportsCount">0</h2>
            <p>Reports Generated</p>
            <button onclick="showSection('reports')">View Reports</button>
          </div>
        </div>
      </section>

      <!-- Procurement Section -->
      <section id="procurement" class="section">
        <h2>Record Procurement</h2>
        <div id="procurementMessage"></div>
        <form id="procurementForm">
          <div>
            <label for="produce-name">Produce Name:</label>
            <input type="text" id="produce-name" required>
          </div>
          <div>
            <label for="produce-type">Produce Type:</label>
            <input type="text" id="produce-type" required>
          </div>
          <div>
            <label for="tonnage">Tonnage:</label>
            <input type="number" id="tonnage" required>
          </div>
          <div>
            <label for="cost">Cost:</label>
            <input type="number" id="cost" required>
          </div>
          <div>
            <label for="dealer-name">Dealer Name:</label>
            <input type="text" id="dealer-name" required>
          </div>
          <div>
            <label for="branch">Branch:</label>
            <select id="branch" required>
              <option value="">Select Branch</option>
              <option value="branch1">Branch 1</option>
              <option value="branch2">Branch 2</option>
            </select>
          </div>
          <div>
            <label for="contact">Contact:</label>
            <input type="text" id="contact" required>
          </div>
          <div>
            <label for="sale-price">Sale Price:</label>
            <input type="number" id="sale-price" required>
          </div>
          <button type="submit">Record Procurement</button>
        </form>
      </section>

      <!-- Stock Section -->
      <section id="stock" class="section">
        <h2>Manage Stock</h2>
        <table>
          <thead>
            <tr>
              <th>Produce Name</th>
              <th>Type</th>
              <th>Tonnage</th>
              <th>Cost</th>
              <th>Branch</th>
            </tr>
          </thead>
          <tbody id="stock-table-body">
            <tr>
              <td colspan="5" style="text-align: center;">Loading stock data...</td>
            </tr>
          </tbody>
        </table>
      </section>

      <!-- Sales Section -->
      <section id="sales" class="section">
        <h2>Record Sales</h2>
        <div id="salesMessage"></div>
        <form id="salesForm">
          <div>
            <label for="produce-name-sales">Produce Name:</label>
            <select id="produce-name-sales" required>
              <option value="">Select Produce</option>
            </select>
          </div>
          <div>
            <label for="tonnage-sales">Tonnage:</label>
            <input type="number" id="tonnage-sales" required>
          </div>
          <div>
            <label for="amount-paid">Amount Paid:</label>
            <input type="number" id="amount-paid" required>
          </div>
          <div>
            <label for="buyer-name">Buyer Name:</label>
            <input type="text" id="buyer-name" required>
          </div>
          <div>
            <label for="sales-agent-name">Sales Agent Name:</label>
            <input type="text" id="sales-agent-name" required>
          </div>
          <button type="submit">Record Sales</button>
        </form>
      </section>

      <!-- Reports Section -->
      <section id="reports" class="section">
        <h2>View Reports</h2>
        <form id="reportsForm">
          <div>
            <label for="report-type">Report Type:</label>
            <select id="report-type" required>
              <option value="">Select Report Type</option>
              <option value="sales-report">Sales Report</option>
              <option value="stock-report">Stock Report</option>
            </select>
          </div>
          <div>
            <label for="branch-report">Branch:</label>
            <select id="branch-report" required>
              <option value="">Select Branch</option>
              <option value="branch1">Branch 1</option>
              <option value="branch2">Branch 2</option>
            </select>
          </div>
          <button type="submit">View Report</button>
        </form>
      </section>
    </div>
  </div>

  <script>
    // Check authentication
    document.addEventListener('DOMContentLoaded', () => {
      try {
        const token = localStorage.getItem('token');
        if (!token) {
          window.location.href = '/login';
          return;
        }

        // Load user info
        const userName = localStorage.getItem('userName') || 'User';
        const userRole = localStorage.getItem('role') || 'Manager';
        const userPhoto = localStorage.getItem('userPhoto');
        
        document.getElementById('userName').textContent = userName;
        document.getElementById('userRole').textContent = `Role: ${userRole.charAt(0).toUpperCase() + userRole.slice(1)}`;
        
        // Load profile photo if available
        if (userPhoto) {
          const profileImg = document.getElementById('profileImg');
          if (profileImg) {
            profileImg.src = userPhoto;
            profileImg.style.display = 'block';
          }
        }

        // Load data - with error handling
        loadStockData().catch(err => console.error('Stock load error:', err));
        loadProcurementData().catch(err => console.error('Procurement load error:', err));
        
        // Form event listeners
        const procForm = document.getElementById('procurementForm');
        const salesForm = document.getElementById('salesForm');
        const reportForm = document.getElementById('reportsForm');
        
        if (procForm) procForm.addEventListener('submit', submitProcurement);
        if (salesForm) salesForm.addEventListener('submit', submitSales);
        if (reportForm) reportForm.addEventListener('submit', submitReports);
      } catch (error) {
        console.error('Dashboard initialization error:', error);
        alert('Error loading dashboard. Please refresh the page.');
      }
    });

    function showSection(sectionId) {
      try {
        const sections = document.querySelectorAll('.section');
        sections.forEach(section => {
          section.classList.remove('active');
        });
        const target = document.getElementById(sectionId);
        if (target) {
          target.classList.add('active');
        }

        // Update navbar active state
        document.querySelectorAll('.nav-links a').forEach(link => {
          link.classList.remove('active');
        });
      } catch (error) {
        console.error('Error showing section:', error);
      }
    }

    function logout() {
      try {
        localStorage.removeItem('token');
        localStorage.removeItem('role');
        localStorage.removeItem('userId');
        localStorage.removeItem('userName');
        localStorage.removeItem('userPhoto');
        window.location.href = '/login';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/login';
      }
    }

    async function loadStockData() {
      try {
        const response = await fetch('/api/procurement');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        const tbody = document.getElementById('stock-table-body');
        
        if (!tbody) return;
        
        tbody.innerHTML = '';

        if (!data || data.length === 0) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center;">No stock data available</td></tr>';
          document.getElementById('totalStock').textContent = '0';
          return;
        }

        data.forEach(item => {
          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${item.name || 'N/A'}</td>
            <td>${item.type || 'N/A'}</td>
            <td>${item.tonnage || '0'}</td>
            <td>$${item.cost || '0'}</td>
            <td>${item.branch || 'N/A'}</td>
          `;
          tbody.appendChild(row);
        });

        document.getElementById('totalStock').textContent = data.length;
      } catch (error) {
        console.error('Error loading stock:', error);
        const tbody = document.getElementById('stock-table-body');
        if (tbody) {
          tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; color: red;">Error loading stock data</td></tr>';
        }
      }
    }

    async function loadProcurementData() {
      try {
        const response = await fetch('/api/procurement');
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        const data = await response.json();
        
        if (!Array.isArray(data)) {
          console.warn('Procurement data is not an array');
          return;
        }
        
        document.getElementById('procurementPending').textContent = data.length;

        // Populate produce dropdown for sales
        const select = document.getElementById('produce-name-sales');
        if (select) {
          select.innerHTML = '<option value="">Select Produce</option>';
          data.forEach(item => {
            const option = document.createElement('option');
            option.value = item._id || '';
            option.textContent = item.name || 'Unknown';
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading procurement:', error);
      }
    }

    async function submitProcurement(e) {
      e.preventDefault();
      
      try {
        const formData = {
          name: document.getElementById('produce-name').value,
          type: document.getElementById('produce-type').value,
          tonnage: document.getElementById('tonnage').value,
          cost: document.getElementById('cost').value,
          dealerName: document.getElementById('dealer-name').value,
          branch: document.getElementById('branch').value,
          contact: document.getElementById('contact').value,
          salePrice: document.getElementById('sale-price').value
        };

        const response = await fetch('/api/procurement', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(formData)
        });

        const messageDiv = document.getElementById('procurementMessage');
        if (response.ok) {
          messageDiv.innerHTML = '<div class="message success">Procurement recorded successfully!</div>';
          document.getElementById('procurementForm').reset();
          loadStockData().catch(err => console.error('Stock reload error:', err));
          loadProcurementData().catch(err => console.error('Procurement reload error:', err));
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          const error = await response.json().catch(() => ({}));
          messageDiv.innerHTML = `<div class="message error">Error: ${error.error || 'Failed to record procurement'}</div>`;
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('procurementMessage').innerHTML = '<div class="message error">Error submitting form</div>';
      }
    }

    async function submitSales(e) {
      e.preventDefault();
      
      try {
        const formData = {
          produceName: document.getElementById('produce-name-sales').value,
          tonnage: document.getElementById('tonnage-sales').value,
          amountPaid: document.getElementById('amount-paid').value,
          buyerName: document.getElementById('buyer-name').value,
          salesAgentName: document.getElementById('sales-agent-name').value
        };

        const response = await fetch('/api/sales', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${localStorage.getItem('token')}`
          },
          body: JSON.stringify(formData)
        });

        const messageDiv = document.getElementById('salesMessage');
        if (response.ok) {
          messageDiv.innerHTML = '<div class="message success">Sale recorded successfully!</div>';
          document.getElementById('salesForm').reset();
          setTimeout(() => {
            messageDiv.innerHTML = '';
          }, 3000);
        } else {
          const error = await response.json().catch(() => ({}));
          messageDiv.innerHTML = `<div class="message error">Error: ${error.error || 'Failed to record sale'}</div>`;
        }
      } catch (error) {
        console.error('Error:', error);
        document.getElementById('salesMessage').innerHTML = '<div class="message error">Error submitting form</div>';
      }
    }

    async function submitReports(e) {
      e.preventDefault();
      
      try {
        const reportType = document.getElementById('report-type').value;
        const branch = document.getElementById('branch-report').value;

        alert(`Generating ${reportType} for ${branch}`);
        // Add report generation logic here
      } catch (error) {
        console.error('Error:', error);
        alert('Error generating report');
      }
    }
  </script>
</body>
</html>